# Architecture Overview

## 疎結合設計

Shienは、ログ記録機能とCLI機能が疎結合になるよう設計されています。

```
┌─────────────┐                    ┌──────────────┐
│   shienctl  │                    │ Activity Log │
│    (CLI)    │                    │   Worker     │
└──────┬──────┘                    └──────┬───────┘
       │                                  │
       │ RPC Protocol                     │ Direct call
       ▼                                  │
┌─────────────────────────────────┐       │
│         RPC Server              │       │
└─────────────┬───────────────────┘       │
              │                           │
              ▼                           ▼
┌─────────────────────────────────────────────────┐
│              Service Layer                      │
│  ┌─────────────────────┬─────────────────────┐  │
│  │    Activity         │      Config         │  │
│  │    Service          │      Service        │  │
│  └─────────────────────┴─────────────────────┘  │
└─────────────────────┬───────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│            Repository Layer                     │
│  ┌─────────────────────┬─────────────────────┐  │
│  │    Activity         │      Future         │  │
│  │    Repo             │      Repos          │  │
│  └─────────────────────┴─────────────────────┘  │
└─────────────────────┬───────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────┐
│                   Database                      │
└─────────────────────────────────────────────────┘
```

## レイヤーの責務

### 1. Activity Log Worker (daemon内)
- **責務**: 定期的にアクティビティを記録
- **依存**: Service Layer (Activity Service)
- **独立性**: RPCやCLIの変更に影響されない

### 2. RPC Server
- **責務**: 通信プロトコルの処理のみ
- **依存**: Service Layer
- **独立性**: ビジネスロジックを持たない

### 3. Service Layer
- **責務**: ビジネスロジックの実装
- **依存**: Repository Layer
- **独立性**: 表示層（CLI）や通信層（RPC）から独立

### 4. Repository Layer
- **責務**: データアクセスの抽象化
- **依存**: Database
- **独立性**: ビジネスロジックから独立

## 拡張時の影響範囲

### 新しいログ記録機能を追加する場合
1. `repository/`に新しいリポジトリを追加
2. `service/`に新しいサービスを追加
3. `daemon`でサービスを使用
→ CLI側は変更不要

### 新しいCLIコマンドを追加する場合
1. `protocol.go`に新しいメソッドを定義
2. `server.go`にハンドラーを追加
3. `shienctl`にコマンドを追加
→ ログ記録側は変更不要

### データベーススキーマを変更する場合
1. `migrations/`に新しいマイグレーションを追加
2. 必要に応じてリポジトリを更新
→ サービス層のインターフェースが変わらなければ上位層は変更不要

## 設計の利点

1. **単一責任の原則**: 各レイヤーが明確な責務を持つ
2. **依存性逆転の原則**: 上位層は下位層の抽象に依存
3. **開放閉鎖の原則**: 新機能追加時に既存コードの変更が最小限
4. **インターフェース分離の原則**: 必要なメソッドのみを公開

この設計により、ログ記録機能とCLI機能はそれぞれ独立して進化できます。